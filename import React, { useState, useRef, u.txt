import React, { useState, useRef, useEffect } from 'react';
import { 
  Upload, 
  Download, 
  Type, 
  Square, 
  Trash2, 
  Move, 
  Image as ImageIcon,
  Palette,
  ShoppingBag,
  Zap,
  Truck
} from 'lucide-react';

const AffiliateGenerator = () => {
  const canvasRef = useRef(null);
  const [image, setImage] = useState(null);
  const [elements, setElements] = useState([]);
  const [selectedId, setSelectedId] = useState(null);
  const [canvasSize] = useState({ width: 800, height: 800 });
  const [frameColor, setFrameColor] = useState('transparent'); // 'orange', 'green', 'black'
  
  // State untuk dragging
  const [isDragging, setIsDragging] = useState(false);
  const [dragStart, setDragStart] = useState({ x: 0, y: 0 });

  // Load Image
  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          setImage(img);
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }
  };

  // Add Text Element
  const addText = () => {
    const newElement = {
      id: Date.now(),
      type: 'text',
      text: 'Rp 99.000',
      x: canvasSize.width / 2,
      y: canvasSize.height / 2,
      color: '#ffffff',
      bgColor: '#ff0000',
      fontSize: 60,
      fontFamily: 'Arial',
      fontWeight: 'bold',
      padding: 10
    };
    setElements([...elements, newElement]);
    setSelectedId(newElement.id);
  };

  // Add Badge/Sticker Element
  const addBadge = (badgeType) => {
    let text = '';
    let bgColor = '';
    
    switch(badgeType) {
      case 'free_shipping':
        text = 'GRATIS ONGKIR';
        bgColor = '#00bfa5'; // Teal
        break;
      case 'flash_sale':
        text = 'FLASH SALE';
        bgColor = '#f59e0b'; // Amber
        break;
      case 'cod':
        text = 'BISA COD';
        bgColor = '#2563eb'; // Blue
        break;
      case 'discount':
        text = 'DISKON 50%';
        bgColor = '#dc2626'; // Red
        break;
      default:
        text = 'PROMO';
        bgColor = '#000000';
    }

    const newElement = {
      id: Date.now(),
      type: 'badge',
      text: text,
      x: canvasSize.width / 2,
      y: canvasSize.height / 2,
      color: '#ffffff',
      bgColor: bgColor,
      fontSize: 40,
      width: 300,
      height: 80
    };
    setElements([...elements, newElement]);
    setSelectedId(newElement.id);
  };

  // Delete Element
  const deleteElement = () => {
    if (selectedId) {
      setElements(elements.filter(el => el.id !== selectedId));
      setSelectedId(null);
    }
  };

  // Draw Canvas
  useEffect(() => {
    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');

    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Draw Background Color/Fill
    ctx.fillStyle = '#f3f4f6';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Draw Product Image (Cover/Contain logic simplified)
    if (image) {
      const scale = Math.max(canvas.width / image.width, canvas.height / image.height);
      const x = (canvas.width / 2) - (image.width / 2) * scale;
      const y = (canvas.height / 2) - (image.height / 2) * scale;
      ctx.drawImage(image, x, y, image.width * scale, image.height * scale);
    } else {
      // Placeholder text
      ctx.fillStyle = '#9ca3af';
      ctx.font = '30px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('Upload Foto Produk', canvas.width / 2, canvas.height / 2);
    }

    // Draw Frame
    if (frameColor !== 'transparent') {
      const borderWidth = 30;
      ctx.strokeStyle = frameColor;
      ctx.lineWidth = borderWidth;
      ctx.strokeRect(0, 0, canvas.width, canvas.height);
    }

    // Draw Elements
    elements.forEach(el => {
      ctx.save();
      
      if (el.type === 'text') {
        ctx.font = `${el.fontWeight} ${el.fontSize}px ${el.fontFamily}`;
        ctx.textBaseline = 'middle';
        ctx.textAlign = 'center';
        
        const textWidth = ctx.measureText(el.text).width;
        const textHeight = el.fontSize; // Approx

        // Background for text
        if (el.bgColor !== 'transparent') {
          ctx.fillStyle = el.bgColor;
          // Rounded rect simulation
          const p = el.padding || 10;
          ctx.fillRect(
            el.x - textWidth/2 - p, 
            el.y - textHeight/2 - p, 
            textWidth + (p*2), 
            textHeight + (p*2)
          );
        }

        ctx.fillStyle = el.color;
        ctx.fillText(el.text, el.x, el.y);

        // Selection border
        if (el.id === selectedId) {
          ctx.strokeStyle = '#3b82f6';
          ctx.lineWidth = 2;
          const p = el.padding || 10;
          ctx.strokeRect(
             el.x - textWidth/2 - p - 2, 
            el.y - textHeight/2 - p - 2, 
            textWidth + (p*2) + 4, 
            textHeight + (p*2) + 4
          );
        }
      } else if (el.type === 'badge') {
        // Draw standard badge shape
        ctx.fillStyle = el.bgColor;
        ctx.beginPath();
        // Ellipse or Rounded Rect
        ctx.roundRect(el.x - el.width/2, el.y - el.height/2, el.width, el.height, 20);
        ctx.fill();

        ctx.fillStyle = el.color;
        ctx.font = `bold ${el.fontSize}px Arial`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(el.text, el.x, el.y);

         // Selection border
         if (el.id === selectedId) {
          ctx.strokeStyle = '#3b82f6';
          ctx.lineWidth = 3;
          ctx.strokeRect(el.x - el.width/2 - 2, el.y - el.height/2 - 2, el.width + 4, el.height + 4);
        }
      }

      ctx.restore();
    });

  }, [image, elements, selectedId, frameColor, canvasSize]);

  // Handle Canvas Interaction (Simple Hit Detection)
  const getMousePos = (e) => {
    const rect = canvasRef.current.getBoundingClientRect();
    // Calculate scale factor because canvas CSS size might differ from internal resolution
    const scaleX = canvasRef.current.width / rect.width;
    const scaleY = canvasRef.current.height / rect.height;
    return {
      x: (e.clientX - rect.left) * scaleX,
      y: (e.clientY - rect.top) * scaleY
    };
  };

  const handleMouseDown = (e) => {
    const pos = getMousePos(e);
    // Reverse check to select top-most element first
    const clickedElement = [...elements].reverse().find(el => {
      // Very basic hit detection (box approximation)
      // For real apps, use proper bounding box calculation based on text metrics
      const width = el.type === 'badge' ? el.width : (el.text.length * el.fontSize * 0.6); 
      const height = el.type === 'badge' ? el.height : el.fontSize + 20;
      
      return (
        pos.x >= el.x - width/2 &&
        pos.x <= el.x + width/2 &&
        pos.y >= el.y - height/2 &&
        pos.y <= el.y + height/2
      );
    });

    if (clickedElement) {
      setSelectedId(clickedElement.id);
      setIsDragging(true);
      setDragStart({ x: pos.x - clickedElement.x, y: pos.y - clickedElement.y });
    } else {
      setSelectedId(null);
    }
  };

  const handleMouseMove = (e) => {
    if (isDragging && selectedId) {
      const pos = getMousePos(e);
      setElements(elements.map(el => {
        if (el.id === selectedId) {
          return { ...el, x: pos.x - dragStart.x, y: pos.y - dragStart.y };
        }
        return el;
      }));
    }
  };

  const handleMouseUp = () => {
    setIsDragging(false);
  };

  // Update selected element property
  const updateSelected = (key, value) => {
    setElements(elements.map(el => {
      if (el.id === selectedId) {
        return { ...el, [key]: value };
      }
      return el;
    }));
  };

  const downloadImage = () => {
    // Unselect first so selection border doesn't show
    const prevSelection = selectedId;
    setSelectedId(null);
    
    // Wait for render cycle (hacky but works for this simple case)
    setTimeout(() => {
      const canvas = canvasRef.current;
      const link = document.createElement('a');
      link.download = 'affiliate-image.png';
      link.href = canvas.toDataURL();
      link.click();
      setSelectedId(prevSelection);
    }, 50);
  };

  const selectedElement = elements.find(el => el.id === selectedId);

  return (
    <div className="flex flex-col h-screen bg-gray-100 font-sans">
      {/* Header */}
      <header className="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-sm z-10">
        <div className="flex items-center gap-2">
          <div className="bg-indigo-600 p-2 rounded-lg text-white">
            <ShoppingBag size={20} />
          </div>
          <h1 className="text-xl font-bold text-gray-800">ENDUL Affiliate</h1>
        </div>
        <button 
          onClick={downloadImage}
          className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium transition-colors"
        >
          <Download size={18} /> Download Gambar
        </button>
      </header>

      <div className="flex flex-1 overflow-hidden">
        {/* Left Toolbar */}
        <div className="w-80 bg-white border-r border-gray-200 flex flex-col overflow-y-auto">
          <div className="p-6 space-y-6">
            
            {/* Upload Section */}
            <div>
              <h3 className="text-xs font-bold text-gray-500 uppercase mb-3 tracking-wider">Foto Produk</h3>
              <label className="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 rounded-xl cursor-pointer hover:bg-gray-50 hover:border-indigo-400 transition-all group">
                <div className="flex flex-col items-center justify-center pt-5 pb-6">
                  <Upload className="w-8 h-8 text-gray-400 group-hover:text-indigo-500 mb-2" />
                  <p className="text-sm text-gray-500">Klik untuk Upload</p>
                </div>
                <input type="file" className="hidden" accept="image/*" onChange={handleImageUpload} />
              </label>
            </div>

            <hr className="border-gray-100" />

            {/* Frame Section */}
            <div>
              <h3 className="text-xs font-bold text-gray-500 uppercase mb-3 tracking-wider">Bingkai / Frame</h3>
              <div className="grid grid-cols-4 gap-2">
                <button onClick={() => setFrameColor('transparent')} className={`h-10 rounded border ${frameColor === 'transparent' ? 'ring-2 ring-indigo-500' : 'border-gray-200'} bg-white flex items-center justify-center text-xs text-gray-400`}>None</button>
                <button onClick={() => setFrameColor('#ea580c')} className={`h-10 rounded ${frameColor === '#ea580c' ? 'ring-2 ring-offset-1 ring-orange-600' : ''} bg-orange-600`}></button>
                <button onClick={() => setFrameColor('#16a34a')} className={`h-10 rounded ${frameColor === '#16a34a' ? 'ring-2 ring-offset-1 ring-green-600' : ''} bg-green-600`}></button>
                <button onClick={() => setFrameColor('#000000')} className={`h-10 rounded ${frameColor === '#000000' ? 'ring-2 ring-offset-1 ring-gray-900' : ''} bg-black`}></button>
              </div>
            </div>

            <hr className="border-gray-100" />

            {/* Elements Section */}
            <div>
              <h3 className="text-xs font-bold text-gray-500 uppercase mb-3 tracking-wider">Tambah Elemen</h3>
              <div className="grid grid-cols-2 gap-3">
                <button onClick={addText} className="flex flex-col items-center justify-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                  <Type className="w-6 h-6 text-gray-600 mb-1" />
                  <span className="text-xs font-medium text-gray-700">Teks Harga</span>
                </button>
                <button onClick={() => addBadge('free_shipping')} className="flex flex-col items-center justify-center p-3 border border-gray-200 rounded-lg hover:bg-teal-50 hover:border-teal-200 transition-colors">
                  <Truck className="w-6 h-6 text-teal-600 mb-1" />
                  <span className="text-xs font-medium text-gray-700">Gratis Ongkir</span>
                </button>
                <button onClick={() => addBadge('discount')} className="flex flex-col items-center justify-center p-3 border border-gray-200 rounded-lg hover:bg-red-50 hover:border-red-200 transition-colors">
                  <Zap className="w-6 h-6 text-red-600 mb-1" />
                  <span className="text-xs font-medium text-gray-700">Diskon</span>
                </button>
                <button onClick={() => addBadge('cod')} className="flex flex-col items-center justify-center p-3 border border-gray-200 rounded-lg hover:bg-blue-50 hover:border-blue-200 transition-colors">
                  <ShoppingBag className="w-6 h-6 text-blue-600 mb-1" />
                  <span className="text-xs font-medium text-gray-700">COD</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        {/* Center Canvas */}
        <div className="flex-1 bg-gray-100 overflow-auto flex items-center justify-center p-8 relative">
          <div className="relative shadow-2xl">
            <canvas 
              ref={canvasRef}
              width={canvasSize.width}
              height={canvasSize.height}
              onMouseDown={handleMouseDown}
              onMouseMove={handleMouseMove}
              onMouseUp={handleMouseUp}
              onMouseLeave={handleMouseUp}
              className="bg-white max-w-full max-h-[80vh] h-auto w-auto cursor-crosshair touch-none rounded-lg"
              style={{ 
                width: 'min(500px, 90vw)', 
                height: 'min(500px, 90vw)' 
              }}
            />
            {!image && (
              <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                <p className="text-gray-400 bg-white/80 px-4 py-2 rounded-full text-sm">Preview Area</p>
              </div>
            )}
          </div>
        </div>

        {/* Right Properties Panel */}
        {selectedElement ? (
          <div className="w-72 bg-white border-l border-gray-200 flex flex-col p-6 animate-in slide-in-from-right duration-200">
            <div className="flex justify-between items-center mb-6">
              <h3 className="font-bold text-gray-800">Edit Elemen</h3>
              <button 
                onClick={deleteElement}
                className="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-colors"
                title="Hapus Elemen"
              >
                <Trash2 size={18} />
              </button>
            </div>

            <div className="space-y-5">
              {/* Text Input */}
              <div>
                <label className="block text-xs font-semibold text-gray-500 mb-1">Isi Teks</label>
                <input 
                  type="text" 
                  value={selectedElement.text} 
                  onChange={(e) => updateSelected('text', e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                />
              </div>

              {/* Colors */}
              <div>
                <label className="block text-xs font-semibold text-gray-500 mb-2">Warna Background</label>
                <div className="flex gap-2 flex-wrap">
                  {['#dc2626', '#ea580c', '#f59e0b', '#16a34a', '#2563eb', '#000000', 'transparent'].map(c => (
                    <button 
                      key={c}
                      onClick={() => updateSelected('bgColor', c)}
                      className={`w-8 h-8 rounded-full border border-gray-200 ${c === 'transparent' ? 'bg-white bg-opacity-50' : ''} ${selectedElement.bgColor === c ? 'ring-2 ring-indigo-500 ring-offset-2' : ''}`}
                      style={{ backgroundColor: c }}
                      title={c}
                    >
                      {c === 'transparent' && <span className="text-red-500 text-xs">/</span>}
                    </button>
                  ))}
                </div>
              </div>

               <div>
                <label className="block text-xs font-semibold text-gray-500 mb-2">Warna Teks</label>
                <div className="flex gap-2 flex-wrap">
                  {['#ffffff', '#000000', '#facc15'].map(c => (
                    <button 
                      key={c}
                      onClick={() => updateSelected('color', c)}
                      className={`w-8 h-8 rounded-full border border-gray-200 ${selectedElement.color === c ? 'ring-2 ring-indigo-500 ring-offset-2' : ''}`}
                      style={{ backgroundColor: c }}
                    />
                  ))}
                </div>
              </div>

              {/* Size Slider */}
              <div>
                <label className="block text-xs font-semibold text-gray-500 mb-1">Ukuran Font ({selectedElement.fontSize}px)</label>
                <input 
                  type="range" 
                  min="20" 
                  max="150" 
                  value={selectedElement.fontSize} 
                  onChange={(e) => updateSelected('fontSize', parseInt(e.target.value))}
                  className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                />
              </div>

              <div className="bg-blue-50 p-4 rounded-lg">
                <p className="text-xs text-blue-600 flex gap-2">
                  <Move size={14} className="mt-0.5" />
                  Geser elemen langsung di area kanvas untuk memindahkan posisi.
                </p>
              </div>

            </div>
          </div>
        ) : (
          <div className="w-72 bg-white border-l border-gray-200 flex flex-col items-center justify-center p-6 text-center text-gray-400">
             <Palette size={40} className="mb-3 opacity-20" />
             <p className="text-sm">Pilih elemen di kanvas atau tambahkan elemen baru untuk mengedit propertinya.</p>
          </div>
        )}
      </div>
    </div>
  );
};

export default AffiliateGenerator;